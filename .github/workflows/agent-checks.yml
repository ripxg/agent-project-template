name: Agent Compliance Checks

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  check-agent-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Check for agent registration
      run: |
        # Check if manifest has active agents for recent commits
        if git diff --name-only HEAD~1 HEAD | grep -q "^src/\|^docs/delivery/"; then
          echo "Code changes detected, verifying agent registration..."
          
          if ! grep -q "active" docs/agents/manifest.md; then
            echo "WARNING: No active agents in manifest"
            echo "Ensure agents are properly registered"
          fi
        fi
    
    - name: Check for stale locks
      run: |
        # Check if any locks are present (should be empty in PRs)
        if grep -q "^| [^F][^i]" docs/agents/locks.md; then
          echo "WARNING: Active locks found in PR"
          echo "Locks should be released before PR"
          grep "^| [^F][^i]" docs/agents/locks.md
        fi
    
    - name: Check task status consistency
      run: |
        # This is a placeholder - actual implementation would check
        # that task statuses match between task files and task indexes
        echo "Checking task status consistency..."
        
        # Find all task files
        for task_file in docs/delivery/*/[0-9]-*.md; do
          if [ -f "$task_file" ]; then
            echo "Found task: $task_file"
            # TODO: Compare status in task file with tasks.md
          fi
        done
    
    - name: Validate handoff documents
      run: |
        # Check that all handoff documents are properly formatted
        for handoff in docs/agents/handoffs/*.md; do
          if [ -f "$handoff" ] && [[ "$handoff" != *"_TEMPLATE"* ]]; then
            echo "Checking handoff: $handoff"
            
            # Check for required sections
            if ! grep -q "## Context" "$handoff"; then
              echo "ERROR: Missing Context section in $handoff"
              exit 1
            fi
            
            if ! grep -q "## Decisions Made" "$handoff"; then
              echo "ERROR: Missing Decisions Made section in $handoff"
              exit 1
            fi
            
            if ! grep -q "## Next Steps" "$handoff"; then
              echo "ERROR: Missing Next Steps section in $handoff"
              exit 1
            fi
          fi
        done
    
    - name: Check activity log format
      run: |
        # Verify activity log has proper format
        if [ -f docs/agents/activity.md ]; then
          echo "Checking activity log format..."
          
          # Check for date headings
          if ! grep -q "^## [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}" docs/agents/activity.md; then
            echo "WARNING: No date headings found in activity log"
          fi
        fi
    
    - name: Summary
      run: |
        echo ""
        echo "═══════════════════════════════════"
        echo "  Agent Compliance Check Complete"
        echo "═══════════════════════════════════"
        echo ""
        echo "✓ Agent registration checked"
        echo "✓ File locks verified"
        echo "✓ Task status consistency checked"
        echo "✓ Handoff documents validated"
        echo "✓ Activity log format checked"
        echo ""
